<!DOCTYPE html>
<html>
<head>
    <title>OurDefectsByCloser</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"releaseFilter"},{xtype:"container",itemId:"grid"}],launch:function(){this.down("#releaseFilter").add({xtype:"rallyreleasecombobox",itemId:"releaseComboBox",fieldLabel:"Select Release: ",width:310,labelWidth:100,listeners:{ready:this._onReleaseComboboxLoad,change:this._onComboBoxChange,scope:this}})},_onComboBoxChange:function(comboBox){this._defectRecords=[],this._onReleaseComboboxLoad(comboBox)},_onReleaseComboboxLoad:function(comboBox){this.releaseComboBox=this.down("#releaseComboBox"),Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,fetch:["FormattedID","Name","Owner","DisplayName","UserName","RevisionHistory"],filters:[this.releaseComboBox.getQueryFromSelected()],sorters:[{property:"FormattedID",direction:"ASC"}],listeners:{load:this._onDefectDataLoaded,scope:this}})},_onDefectDataLoaded:function(store,data){this._customRecords=[],Ext.Array.each(data,function(defect){this._customRecords.push({_ref:defect.get("_ref"),FormattedID:defect.get("FormattedID"),Name:defect.get("Name"),ClosedBy:"",DateClosed:"",RevisionID:Rally.util.Ref.getOidFromRef(defect.get("RevisionHistory")),RevisionNumber:""})},this),this._getRevisionHistory(data)},_getRevisionHistory:function(defectList){this._currentDefectList=Ext.clone(defectList),this._defectIndex=0;var me=this,count;defectList.length>0?Ext.Array.each(defectList,function(defect){return this._revisionModel=Rally.data.ModelFactory.getModel({type:"RevisionHistory",scope:this,success:function(model){model.load(Rally.util.Ref.getOidFromRef(this._currentDefectList[this._defectIndex].get("RevisionHistory")),{scope:this,success:function(record,operation){record.getCollection("Revisions").load({fetch:!0,scope:this,callback:function(revisions,operation,success){Ext.Array.each(revisions,function(revision){return-1!==revision.data.Description.search("CLOSED DATE added")?(Ext.Array.each(this._customRecords,function(defect){return defect.RevisionID===record.internalId?(defect.RevisionNumber=revision.get("RevisionNumber"),defect.DateClosed=revision.get("CreationDate"),defect.ClosedBy=revision.get("User")._refObjectName,!1):void 0},this),!1):(this._buildGrid(),void 0)},this)}})}}),this._defectIndex+=1}}),count},this):this._buildGrid()},_buildGrid:function(){var customStore=Ext.create("Rally.data.custom.Store",{data:this._customRecords,pageSize:this._customRecords.length});this.grid?this.grid.reconfigure(customStore):this.grid=this.down("#grid").add({xtype:"rallygrid",store:customStore,sortableColumns:!1,showPagingToolbar:!1,columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",flex:1,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"Date Closed",dataIndex:"DateClosed",flex:2},{text:"Revision Number",dataIndex:"RevisionNumber",flex:1},{text:"Closed By",dataIndex:"ClosedBy",flex:1}]})}});

            Rally.launchApp('CustomApp', {
                name:"OurDefectsByCloser",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     margin: 10px;
}
.app .cardboard {
	border: 2px solid green;
}
    </style>
</head>
<body></body>
</html>
